{"ast":null,"code":"var _jsxFileName = \"/Users/craigpickard/Dev/web/hbo-client/src/App.js\";\nimport React, { useState, useEffect } from \"react\";\nimport { w3cwebsocket as W3CWebSocket } from \"websocket\";\nimport { uuid } from \"uuidv4\";\nimport \"./App.css\";\nimport VideoFeed from \"./components/VideoFeed\";\nconst constraints = {\n  video: {\n    width: {\n      max: 320\n    },\n    height: {\n      max: 240\n    },\n    frameRate: {\n      max: 24\n    }\n  },\n  audio: true\n};\nconst client = new W3CWebSocket(\"wss://10.0.1.12:8443\");\n\nfunction App() {\n  // const [roomId, setRoomId] = useState(null);\n  const roomId = uuid();\n  const [state, setState] = useState({\n    roomId: null,\n    me: {\n      uuid: \"\",\n      username: \"\",\n      roomId: \"\",\n      host: false\n    },\n    stream: null,\n    login: true,\n    peerConnections: [],\n    videoFeeds: []\n  });\n  let localStream = \"\";\n  let peerConnections = [];\n  const peerConnectionConfig = {\n    iceServers: [{\n      urls: \"stun:stun.stunprotocol.org:3478\"\n    }, {\n      urls: \"stun:stun.l.google.com:19302\"\n    }]\n  };\n  let hasStream = [];\n  useEffect(() => {\n    // const me = state.me;\n    // console.log({ me });\n    const newMe = { ...me,\n      roomId: uuid()\n    };\n    setState({ ...state,\n      me: newMe\n    }); // setRoomId(uuid());\n\n    console.log(roomId);\n\n    _init();\n  }, []); // componentWillMount() {\n  //   let hash = window.location.hash.replace(\"#\", \"\");\n  //   if (hash.split(\"=\")[0] === \"roomId\") {\n  //     let me =  state.me;\n  //     me.roomId = hash.split(\"=\")[1];\n  //      setState({ me: me });\n  //   }\n  //   (async () => {\n  //      setState({ loading_model: false });\n  //   })();\n\n  const addUser = player => {\n    console.log(\"adding new user\");\n    if (state.players < 2) setState({ ...state,\n      players: [...state.players, player]\n    });else console.log(\"max 2 people per room\");\n  };\n\n  const addVideoFeed = videoFeed => {\n    console.log(\"adding video feed\");\n    setState({ ...state,\n      videoFeeds: [...state.videoFeeds, videoFeed]\n    });\n  };\n\n  function _init() {\n    console.log(\"init websocket\"); // client = new W3CWebSocket(\"wss://10.0.1.12:8443\");\n\n    client.onopen = () => {\n      console.log(\"WebSocket Client Connected\");\n    };\n\n    client.onmessage = message => {\n      let obj = JSON.parse(message.data);\n      console.log(obj);\n\n      switch (obj.eventName) {\n        case \"selfSetup\":\n          setState({ ...state,\n            me: {\n              uuid: obj.data.user.uuid,\n              username: obj.data.user.username,\n              roomId: obj.data.user.room,\n              host: obj.data.user.role === \"HOST\" ? true : false\n            }\n          });\n          console.log(`https://10.0.1.12:3000/#roomId=${obj.data.user.room}`);\n          break;\n\n        case \"p2pAction\":\n          var peerUuid = obj.data.uuid;\n\n          if (peerUuid === state.me.uuid || obj.data.dest !== state.me.uuid && obj.data.dest !== \"all\") {\n            break;\n          }\n\n          if (obj.data.displayName && obj.data.dest === \"all\") {\n            // set up peer connection object for a newcomer peer\n            setUpPeer(peerUuid, obj.data.displayName);\n            client.send(JSON.stringify({\n              eventName: \"p2pAction\",\n              data: {\n                displayName: state.me.username,\n                uuid: state.me.uuid,\n                dest: peerUuid\n              }\n            }));\n          } else if (obj.data.displayName && obj.data.dest === state.me.uuid) {\n            // initiate call if we are the newcomer peer\n            setUpPeer(peerUuid, obj.data.displayName, true);\n          } else if (obj.data.sdp) {\n            peerConnections[peerUuid].pc.setRemoteDescription(new RTCSessionDescription(obj.data.sdp)).then(() => {\n              // Only create answers in response to offers\n              if (obj.data.sdp.type === \"offer\") {\n                peerConnections[peerUuid].pc.createAnswer().then(description => createdDescription(description, peerUuid)).catch(errorHandler);\n              }\n            }).catch(errorHandler);\n          } else if (obj.data.ice) {\n            peerConnections[peerUuid].pc.addIceCandidate(new RTCIceCandidate(obj.data.ice)).catch(errorHandler);\n          }\n\n          break;\n\n        default:\n          break;\n      }\n    };\n  }\n\n  const gotIceCandidate = (event, peerUuid) => {\n    if (event.candidate != null) {\n      client.send(JSON.stringify({\n        eventName: \"p2pAction\",\n        data: {\n          ice: event.candidate,\n          uuid: state.me.uuid,\n          dest: peerUuid\n        }\n      }));\n    }\n  };\n\n  const setUpPeer = (peerUuid, displayName, initCall = false) => {\n    console.log(`setting up webRTC peer: uuid - ${peerUuid}, displayName: ${displayName}`);\n    peerConnections[peerUuid] = {\n      displayName: displayName,\n      pc: new RTCPeerConnection(peerConnectionConfig)\n    };\n\n    peerConnections[peerUuid].pc.onicecandidate = event => gotIceCandidate(event, peerUuid);\n\n    peerConnections[peerUuid].pc.ontrack = event => gotRemoteStream(event, peerUuid);\n\n    peerConnections[peerUuid].pc.oniceconnectionstatechange = event => checkPeerDisconnect(event, peerUuid);\n\n    peerConnections[peerUuid].pc.addStream(localStream);\n\n    if (initCall) {\n      peerConnections[peerUuid].pc.createOffer().then(description => createdDescription(description, peerUuid)).catch(errorHandler);\n    }\n  };\n\n  const errorHandler = err => {\n    console.log(err);\n  };\n\n  const checkPeerDisconnect = (event, peerUuid) => {\n    var states = peerConnections[peerUuid].pc.iceConnectionState;\n    console.log(`connection with peer ${peerUuid} ${states}`);\n\n    if (states === \"failed\" || states === \"closed\" || states === \"disconnected\") {\n      delete peerConnections[peerUuid];\n      let videoFeeds = state.videoFeeds;\n      videoFeeds = videoFeeds.filter(ele => {\n        return ele.peerUUID !== peerUuid;\n      });\n      setState({ ...state,\n        videoFeeds: videoFeeds\n      });\n    }\n  };\n\n  const connectToSocket = () => {\n    console.log(\"connect to socket, roomid: \", state.me.roomId);\n    const {\n      me\n    } = state;\n    let data = {\n      eventName: \"selfSetup\",\n      data: {\n        roomId: me.roomId,\n        displayName: me.username\n      }\n    };\n    client.send(JSON.stringify(data));\n  };\n\n  const gotRemoteStream = (event, peerUuid) => {\n    console.log(event);\n\n    if (event.track.kind === \"video\") {\n      console.log(`got remote stream, peer ${peerUuid}`);\n      let streamRef = React.createRef();\n      let videoFeed = {\n        ref: streamRef,\n        stream: event.streams[0],\n        peerUUID: peerUuid\n      };\n      addVideoFeed(videoFeed);\n    }\n  };\n\n  const onLogin = e => {\n    console.log(\"login\");\n\n    if (state.me.username !== \"\") {\n      console.log(\"setting login to false\"); // setState({ ...state, login: false });\n\n      connectToSocket();\n      navigator.mediaDevices.getUserMedia(constraints).then(stream => {\n        console.log({\n          stream\n        });\n        localStream = stream; // sets it up for the peer\n\n        setState({ ...state,\n          ...{\n            stream,\n            login: false\n          }\n        }); //  sendPrediction = true;\n      }).catch(errorHandler).then(() => {\n        client.send(JSON.stringify({\n          eventName: \"p2pAction\",\n          data: {\n            uuid: state.me.uuid,\n            roomId: state.me.roomId,\n            displayName: state.me.username,\n            dest: \"all\"\n          }\n        }));\n      });\n    }\n  };\n\n  const onUsernameUpdate = e => {\n    console.log({\n      state\n    });\n    console.log(\"should set state:\", e.target.value);\n    const newMe = { ...state.me,\n      username: e.target.value\n    };\n    setState({ ...state,\n      me: newMe\n    });\n  };\n\n  const createdDescription = (description, peerUuid) => {\n    console.log(`got description, peer ${peerUuid}`);\n    peerConnections[peerUuid].pc.setLocalDescription(description).then(() => {\n      client.send(JSON.stringify({\n        eventName: \"p2pAction\",\n        data: {\n          sdp: peerConnections[peerUuid].pc.localDescription,\n          uuid: state.me.uuid,\n          dest: peerUuid\n        }\n      }));\n    }).catch(errorHandler);\n  };\n\n  if (state.login) return /*#__PURE__*/React.createElement(\"div\", {\n    className: \"App\",\n    style: {\n      marginTop: \"15%\"\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 299,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    style: {\n      width: \"725px\",\n      margin: \"0 auto\"\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 300,\n      columnNumber: 9\n    }\n  }, \"webRTC\"), /*#__PURE__*/React.createElement(\"input\", {\n    style: {\n      marginTop: \"44px\"\n    },\n    type: \"text\",\n    placeholder: \"username\",\n    name: \"username\",\n    onChange: onUsernameUpdate,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 301,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(\"input\", {\n    type: \"submit\",\n    value: \"connect\",\n    onClick: onLogin,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 308,\n      columnNumber: 9\n    }\n  }));else return /*#__PURE__*/React.createElement(\"div\", {\n    className: \"App\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 313,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(VideoFeed, {\n    stream: state.stream,\n    videoFeeds: state.videoFeeds,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 314,\n      columnNumber: 9\n    }\n  }));\n}\n\nexport default App;","map":{"version":3,"sources":["/Users/craigpickard/Dev/web/hbo-client/src/App.js"],"names":["React","useState","useEffect","w3cwebsocket","W3CWebSocket","uuid","VideoFeed","constraints","video","width","max","height","frameRate","audio","client","App","roomId","state","setState","me","username","host","stream","login","peerConnections","videoFeeds","localStream","peerConnectionConfig","iceServers","urls","hasStream","newMe","console","log","_init","addUser","player","players","addVideoFeed","videoFeed","onopen","onmessage","message","obj","JSON","parse","data","eventName","user","room","role","peerUuid","dest","displayName","setUpPeer","send","stringify","sdp","pc","setRemoteDescription","RTCSessionDescription","then","type","createAnswer","description","createdDescription","catch","errorHandler","ice","addIceCandidate","RTCIceCandidate","gotIceCandidate","event","candidate","initCall","RTCPeerConnection","onicecandidate","ontrack","gotRemoteStream","oniceconnectionstatechange","checkPeerDisconnect","addStream","createOffer","err","states","iceConnectionState","filter","ele","peerUUID","connectToSocket","track","kind","streamRef","createRef","ref","streams","onLogin","e","navigator","mediaDevices","getUserMedia","onUsernameUpdate","target","value","setLocalDescription","localDescription","marginTop","margin"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { w3cwebsocket as W3CWebSocket } from \"websocket\";\nimport { uuid } from \"uuidv4\";\nimport \"./App.css\";\nimport VideoFeed from \"./components/VideoFeed\";\n\nconst constraints = {\n  video: {\n    width: { max: 320 },\n    height: { max: 240 },\n    frameRate: { max: 24 },\n  },\n  audio: true,\n};\n\nconst client = new W3CWebSocket(\"wss://10.0.1.12:8443\");\nfunction App() {\n  // const [roomId, setRoomId] = useState(null);\n  const roomId = uuid();\n  const [state, setState] = useState({\n    roomId: null,\n    me: {\n      uuid: \"\",\n      username: \"\",\n      roomId: \"\",\n      host: false,\n    },\n    stream: null,\n    login: true,\n    peerConnections: [],\n    videoFeeds: [],\n  });\n\n  let localStream = \"\";\n  let peerConnections = [];\n  const peerConnectionConfig = {\n    iceServers: [\n      { urls: \"stun:stun.stunprotocol.org:3478\" },\n      { urls: \"stun:stun.l.google.com:19302\" },\n    ],\n  };\n\n  let hasStream = [];\n\n  useEffect(() => {\n    // const me = state.me;\n    // console.log({ me });\n    const newMe = { ...me, roomId: uuid() };\n    setState({ ...state, me: newMe });\n    // setRoomId(uuid());\n    console.log(roomId);\n    _init();\n  }, []);\n\n  // componentWillMount() {\n  //   let hash = window.location.hash.replace(\"#\", \"\");\n  //   if (hash.split(\"=\")[0] === \"roomId\") {\n  //     let me =  state.me;\n  //     me.roomId = hash.split(\"=\")[1];\n  //      setState({ me: me });\n  //   }\n  //   (async () => {\n  //      setState({ loading_model: false });\n  //   })();\n\n  const addUser = (player) => {\n    console.log(\"adding new user\");\n    if (state.players < 2)\n      setState({ ...state, players: [...state.players, player] });\n    else console.log(\"max 2 people per room\");\n  };\n\n  const addVideoFeed = (videoFeed) => {\n    console.log(\"adding video feed\");\n    setState({ ...state, videoFeeds: [...state.videoFeeds, videoFeed] });\n  };\n\n  function _init() {\n    console.log(\"init websocket\");\n    // client = new W3CWebSocket(\"wss://10.0.1.12:8443\");\n\n    client.onopen = () => {\n      console.log(\"WebSocket Client Connected\");\n    };\n    client.onmessage = (message) => {\n      let obj = JSON.parse(message.data);\n      console.log(obj);\n      switch (obj.eventName) {\n        case \"selfSetup\":\n          setState({\n            ...state,\n            me: {\n              uuid: obj.data.user.uuid,\n              username: obj.data.user.username,\n              roomId: obj.data.user.room,\n              host: obj.data.user.role === \"HOST\" ? true : false,\n            },\n          });\n          console.log(`https://10.0.1.12:3000/#roomId=${obj.data.user.room}`);\n          break;\n        case \"p2pAction\":\n          var peerUuid = obj.data.uuid;\n          if (\n            peerUuid === state.me.uuid ||\n            (obj.data.dest !== state.me.uuid && obj.data.dest !== \"all\")\n          ) {\n            break;\n          }\n\n          if (obj.data.displayName && obj.data.dest === \"all\") {\n            // set up peer connection object for a newcomer peer\n            setUpPeer(peerUuid, obj.data.displayName);\n            client.send(\n              JSON.stringify({\n                eventName: \"p2pAction\",\n                data: {\n                  displayName: state.me.username,\n                  uuid: state.me.uuid,\n                  dest: peerUuid,\n                },\n              })\n            );\n          } else if (obj.data.displayName && obj.data.dest === state.me.uuid) {\n            // initiate call if we are the newcomer peer\n            setUpPeer(peerUuid, obj.data.displayName, true);\n          } else if (obj.data.sdp) {\n            peerConnections[peerUuid].pc\n              .setRemoteDescription(new RTCSessionDescription(obj.data.sdp))\n              .then(() => {\n                // Only create answers in response to offers\n                if (obj.data.sdp.type === \"offer\") {\n                  peerConnections[peerUuid].pc\n                    .createAnswer()\n                    .then((description) =>\n                      createdDescription(description, peerUuid)\n                    )\n                    .catch(errorHandler);\n                }\n              })\n              .catch(errorHandler);\n          } else if (obj.data.ice) {\n            peerConnections[peerUuid].pc\n              .addIceCandidate(new RTCIceCandidate(obj.data.ice))\n              .catch(errorHandler);\n          }\n          break;\n        default:\n          break;\n      }\n    };\n  }\n\n  const gotIceCandidate = (event, peerUuid) => {\n    if (event.candidate != null) {\n      client.send(\n        JSON.stringify({\n          eventName: \"p2pAction\",\n          data: {\n            ice: event.candidate,\n            uuid: state.me.uuid,\n            dest: peerUuid,\n          },\n        })\n      );\n    }\n  };\n\n  const setUpPeer = (peerUuid, displayName, initCall = false) => {\n    console.log(\n      `setting up webRTC peer: uuid - ${peerUuid}, displayName: ${displayName}`\n    );\n    peerConnections[peerUuid] = {\n      displayName: displayName,\n      pc: new RTCPeerConnection(peerConnectionConfig),\n    };\n    peerConnections[peerUuid].pc.onicecandidate = (event) =>\n      gotIceCandidate(event, peerUuid);\n    peerConnections[peerUuid].pc.ontrack = (event) =>\n      gotRemoteStream(event, peerUuid);\n    peerConnections[peerUuid].pc.oniceconnectionstatechange = (event) =>\n      checkPeerDisconnect(event, peerUuid);\n    peerConnections[peerUuid].pc.addStream(localStream);\n\n    if (initCall) {\n      peerConnections[peerUuid].pc\n        .createOffer()\n        .then((description) => createdDescription(description, peerUuid))\n        .catch(errorHandler);\n    }\n  };\n\n  const errorHandler = (err) => {\n    console.log(err);\n  };\n\n  const checkPeerDisconnect = (event, peerUuid) => {\n    var states = peerConnections[peerUuid].pc.iceConnectionState;\n    console.log(`connection with peer ${peerUuid} ${states}`);\n    if (\n      states === \"failed\" ||\n      states === \"closed\" ||\n      states === \"disconnected\"\n    ) {\n      delete peerConnections[peerUuid];\n      let videoFeeds = state.videoFeeds;\n      videoFeeds = videoFeeds.filter((ele) => {\n        return ele.peerUUID !== peerUuid;\n      });\n      setState({ ...state, videoFeeds: videoFeeds });\n    }\n  };\n\n  const connectToSocket = () => {\n    console.log(\"connect to socket, roomid: \", state.me.roomId);\n    const { me } = state;\n    let data = {\n      eventName: \"selfSetup\",\n      data: {\n        roomId: me.roomId,\n        displayName: me.username,\n      },\n    };\n    client.send(JSON.stringify(data));\n  };\n\n  const gotRemoteStream = (event, peerUuid) => {\n    console.log(event);\n    if (event.track.kind === \"video\") {\n      console.log(`got remote stream, peer ${peerUuid}`);\n      let streamRef = React.createRef();\n      let videoFeed = {\n        ref: streamRef,\n        stream: event.streams[0],\n        peerUUID: peerUuid,\n      };\n      addVideoFeed(videoFeed);\n    }\n  };\n\n  const onLogin = (e) => {\n    console.log(\"login\");\n    if (state.me.username !== \"\") {\n      console.log(\"setting login to false\");\n      // setState({ ...state, login: false });\n      connectToSocket();\n\n      navigator.mediaDevices\n        .getUserMedia(constraints)\n        .then((stream) => {\n          console.log({ stream });\n          localStream = stream; // sets it up for the peer\n          setState({ ...state, ...{ stream, login: false } });\n          //  sendPrediction = true;\n        })\n        .catch(errorHandler)\n        .then(() => {\n          client.send(\n            JSON.stringify({\n              eventName: \"p2pAction\",\n              data: {\n                uuid: state.me.uuid,\n                roomId: state.me.roomId,\n                displayName: state.me.username,\n                dest: \"all\",\n              },\n            })\n          );\n        });\n    }\n  };\n  const onUsernameUpdate = (e) => {\n    console.log({ state });\n    console.log(\"should set state:\", e.target.value);\n    const newMe = { ...state.me, username: e.target.value };\n    setState({ ...state, me: newMe });\n  };\n\n  const createdDescription = (description, peerUuid) => {\n    console.log(`got description, peer ${peerUuid}`);\n    peerConnections[peerUuid].pc\n      .setLocalDescription(description)\n      .then(() => {\n        client.send(\n          JSON.stringify({\n            eventName: \"p2pAction\",\n            data: {\n              sdp: peerConnections[peerUuid].pc.localDescription,\n              uuid: state.me.uuid,\n              dest: peerUuid,\n            },\n          })\n        );\n      })\n      .catch(errorHandler);\n  };\n\n  if (state.login)\n    return (\n      <div className=\"App\" style={{ marginTop: \"15%\" }}>\n        <div style={{ width: \"725px\", margin: \"0 auto\" }}>webRTC</div>\n        <input\n          style={{ marginTop: \"44px\" }}\n          type=\"text\"\n          placeholder=\"username\"\n          name=\"username\"\n          onChange={onUsernameUpdate}\n        />\n        <input type=\"submit\" value=\"connect\" onClick={onLogin} />\n      </div>\n    );\n  else\n    return (\n      <div className=\"App\">\n        <VideoFeed stream={state.stream} videoFeeds={state.videoFeeds} />\n      </div>\n    );\n}\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}